<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!--
       版权所有 (c)  王悦珊
       本代码为西安欧亚学院文化传媒学院广播电视编导专业《影视后期》课程设备预约系统开发。
       未经授权，禁止复制、修改或商用。
       
       系统专利：SmartCineReserve
       系统开发：Yaoshan Wang
       联系方式：wangyueshan@eurasia.edu
       最后更新：2024-12-18
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备预约系统</title>
    <!-- 引用 SF Pro 字体 (Apple License) -->
    <!-- https://developer.apple.com/fonts/ -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap">
    <!-- Bootstrap v5.1.3 (MIT License) -->
    <!-- https://github.com/twbs/bootstrap/blob/main/LICENSE -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome v5.15.4 (Free Version - CC BY 4.0 License) -->
    <!-- https://fontawesome.com/license/free -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* 基础样式 */
        .step-container {
            display: none;
            padding: 20px;
            margin: 0 auto;
        }
        .step-container.active {
            display: block;
        }
        
        /* 设备选择区域布局 */
        .device-selection-container {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
        }
        .device-list {
            flex: 2;
        }
        .selected-panel {
            flex: 1;
            position: sticky;
            top: 20px;
            align-self: flex-start;
        }

        /* Apple 风格的视觉设计 */
        :root {
            --apple-white: #FFFFFF;
            --apple-light-gray: #F5F5F7;
            --apple-dark-gray: #1D1D1F;
            --apple-text-gray: #6E6E73;
            --apple-blue: #0071E3;
            --gradient-1: #007AFF; /* 蓝色 */
            --gradient-2: #6B3FA0; /* 紫色 */
            --gradient-3: #FF6B8B; /* 粉色 */
            --gradient-4: #FF9F0A; /* 橙色 */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(
                135deg,
                var(--gradient-1) 0%,
                var(--gradient-2) 25%,
                var(--gradient-3) 75%,
                var(--gradient-4) 100%
            );
            background-attachment: fixed;
            min-height: 100vh;
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            color: var(--apple-dark-gray);
            line-height: 1.5;
        }

        .navbar {
            background-color: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: saturate(180%) blur(20px);
            border: none;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* 设备卡片网格 */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            padding: 24px;
        }

        .device-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            padding: 1rem;
            max-width: 100%;
            animation: fadeIn 0.5s ease backwards;
            animation-delay: calc(var(--animation-order) * 0.1s);
        }

        .device-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .device-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .device-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .device-card:hover img {
            transform: scale(1.05);
        }

        /* 按钮样式 */
        .btn {
            border-radius: 8px;
            padding: 10px 24px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--apple-blue), #00a0ff);
            border: none;
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 113, 227, 0.3);
        }

        .btn-outline-primary {
            border: 2px solid var(--apple-blue);
            background: transparent;
            color: var(--apple-blue);
        }

        .btn-outline-primary:hover {
            background: var(--apple-blue);
            color: white;
        }

        /* 表单控件 */
        .form-control {
            border: none;
            border-radius: 8px;
            background: var(--apple-light-gray);
            padding: 12px 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            background: white;
            box-shadow: 0 0 0 2px var(--apple-blue);
        }

        .form-label {
            font-weight: 500;
            color: var(--apple-dark-gray);
            margin-bottom: 8px;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        /* 预约列表样式 */
        .table {
            color: var(--apple-dark-gray);
        }

        .badge {
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 6px;
        }

        /* 模态框 */
        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            border: none;
        }

        .modal-header {
            border-bottom: 1px solid var(--apple-light-gray);
        }

        .modal-footer {
            border-top: 1px solid var(--apple-light-gray);
        }

        /* 管理员入口按钮样式 */
        .admin-btn {
            background-color: var(--apple-dark-gray);
            color: var(--apple-white);
            border: 2px solid var(--apple-white);
            padding: 10px 20px;
            font-weight: 500;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        
        .admin-btn:hover {
            background-color: var(--apple-white);
            color: var(--apple-dark-gray);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* 系统标题样式 */
        .system-title {
            font-size: 1.3rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            background: linear-gradient(45deg, var(--apple-dark-gray), #4A4A4A);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            padding: 0.5rem 0;
            white-space: nowrap;
        }
        
        .system-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--apple-blue), transparent);
        }

        /* 确认页面的样式 */
        #step3 .card {
            height: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        #step3 .text-danger {
            color: #dc3545 !important;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        #step3 ol li {
            margin-bottom: 1rem;
        }
        
        #step3 .card-title {
            font-weight: 600;
            font-size: 1.4rem;
        }

        /* 特别为安全提示题添加样式 */
        #step3 .text-danger.card-title {
            font-size: 1.5rem !important;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .progress {
            height: 8px;
            background-color: var(--apple-light-gray);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--apple-blue) 0%, #00a0ff 100%);
            transition: width 0.5s ease;
        }

        .step-indicator {
            position: relative;
            padding: 8px 16px;
            color: var(--apple-text-gray);
            transition: all 0.3s ease;
        }

        .step-indicator.active {
            color: var(--apple-blue);
            font-weight: 600;
        }

        .step-indicator::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--apple-blue);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .step-indicator.active::after {
            transform: scaleX(1);
        }

        .modal.fade .modal-dialog {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-dialog {
            transform: scale(1);
        }

        .modal-content {
            border: none;
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            border-bottom: 1px solid var(--apple-light-gray);
            padding: 20px 24px;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            border-top: 1px solid var(--apple-light-gray);
            padding: 20px 24px;
        }

        .list-group-item {
            transition: all 0.3s ease;
            border: none;
            margin-bottom: 8px;
            border-radius: 8px !important;
            background: var(--apple-light-gray);
        }

        .list-group-item:hover {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateX(4px);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 添加主容器样式 */
        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        /* 添加动画效果 */
        @keyframes gradientAnimation {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand mb-0 system-title">广播电视编导专业《影视后期》课程设备预约系统</span>
            <button class="btn admin-btn" onclick="showAdminLogin()">
                <i class="fas fa-user-shield me-2"></i>管理员入口
            </button>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 进度指示器 -->
        <div class="progress mb-4">
            <div class="progress-bar" 
                 role="progressbar" 
                 aria-label="预约进度" 
                 aria-valuenow="33" 
                 aria-valuemin="0" 
                 aria-valuemax="100" 
                 style="width: 33%">
                <span class="visually-hidden">当前进度：33%</span>
            </div>
        </div>

        <!-- 步骤指示器 -->
        <div class="d-flex justify-content-between mb-4 px-5">
            <span class="step-indicator active">1. 设备选择</span>
            <span class="step-indicator">2. 信息填写</span>
            <span class="step-indicator">3. 确认预约</span>
        </div>

        <!-- 步骤1：设备选择 -->
        <div id="step1" class="step-container active">
            <h2 class="text-center mb-4">第一步：设备选择</h2>
            <div class="device-selection-container">
                <div class="device-list">
                    <div class="device-grid" id="deviceGrid"></div>
                </div>
                <div class="selected-panel">
                    <div class="selected-devices" id="selectedDevices" style="display: none;">
                        <h2>已选设备</h2>
                        <ul id="selectedDevicesList" class="list-group mb-4"></ul>
                        <div class="d-grid">
                            <button class="btn btn-primary btn-lg" onclick="nextStep()">下一步</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 添加预列表展示区域 -->
            <div class="booking-list-container mt-5">
                <h2 class="text-center mb-4">当前预约列表</h2>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>班级</th>
                                <th>姓名</th>
                                <th>借用时间</th>
                                <th>归还时间</th>
                                <th>借用设备</th>
                                <th>借用理由</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody id="publicBookingList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 步骤2：信息填写 -->
        <div id="step2" class="step-container">
            <h2 class="text-center mb-4">第二步：预约信息填</h2>
            <div class="alert alert-warning">
                本页面仅用于《影视后期》课程的设备预约，其他课程请联系相关任课教师。
            </div>
            <form id="bookingForm" style="max-width: 600px; margin: 0 auto;">
                <div class="mb-3">
                    <label class="form-label">班级</label>
                    <input type="text" class="form-control" required
                           pattern="^广编\d{4}班$" 
                           placeholder="请输入班级（广编2301班）"
                           onblur="validateClassInput(this)">
                </div>
                <div class="mb-3">
                    <label class="form-label">姓名</label>
                    <input type="text" class="form-control" required
                           placeholder="请输入真实姓名">
                </div>
                <div class="mb-3">
                    <label class="form-label">借用时间</label>
                    <input type="datetime-local" class="form-control" required
                           onchange="updateReturnTimeLimit()"
                           data-first-day="1"
                           step="1800"
                           min=""
                           max="">
                    <div class="form-text text-muted">
                        <small>借用周期为1-3天，工作时间9:00-17:30</small>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">归还时间</label>
                    <input type="datetime-local" class="form-control" required
                           data-first-day="1"
                           step="1800"
                           min=""
                           max="">
                </div>
                <div class="mb-3">
                    <label class="form-label">借用理由</label>
                    <textarea class="form-control" rows="3" required
                              placeholder="请输入借用理由 例如：期末大作业"></textarea>
                </div>
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">上一步</button>
                    <button type="button" class="btn btn-success" onclick="goToConfirmStep()">确认预约</button>
                </div>
            </form>
        </div>

        <!-- 步骤3：确认信息 -->
        <div id="step3" class="step-container">
            <h2 class="text-center mb-4">第三步：确认预约</h2>
            <div class="row">
                <!-- 左侧安全提示 -->
                <div class="col-md-5">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h3 class="card-title text-danger mb-4">请注意设备使用安全 截图保存</h3>
                            <ol class="text-danger" style="padding-left: 1.2rem;">
                                <li class="mb-2">三脚架使用方法：取出三脚架时不要用力拽，每次只拉出一节，再调整下一节，确保稳固。</li>
                                <li class="mb-2">不用相机时，记得盖好镜头盖，防止镜头进灰或划伤。</li>
                                <li class="mb-2">小保管镜盖和相机热靴、收音设备的红线，千万不要遗失。</li>
                                <li class="mb-2">不要随意甩动相机或摇晃设备，避免损坏。</li>
                                <li class="mb-2">使用时注意防潮、防尘、防摔，远离极端温度环境。</li>
                                <li class="mb-2">未经许可，不可拆卸设备部或进行改装操作。</li>
                                <li class="mb-2">归还设备前，请确认配套齐全无损，并完成素材拷贝工作</li>
                                <li class="mb-2">设备遗失或损坏需按规定赔偿，请妥善使用！</li>
                            </ol>
                        </div>
                    </div>
                </div>
                <!-- 右侧预约信息 -->
                <div class="col-md-7">
                    <div class="card">
                        <div class="card-body">
                            <div id="summaryContent"></div>
                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-secondary" onclick="prevStep()">上一步</button>
                                <button class="btn btn-success" onclick="confirmBooking()">确认预约</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入Bootstrap的JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 现有的JavaScript代保持不变 -->
    <script>
        const initialDevices = [
            { id: 1, name: '相机包', stock: 8, image: './camera-bag.jpg' },
            { id: 2, name: 'Sony M3 相机（含uv镜）', stock: 8, image: './sony-m3-camera.jpg' },
            { id: 3, name: '28-70mm 镜头', stock: 8, image: './28-70mm-lens.jpg' },
            { id: 4, name: '80定焦镜头', stock: 2, image: './80mm-lens.jpg' },
            { id: 5, name: '三脚架', stock: 8, image: './tripod.jpg' },
            { id: 6, name: '64G内存卡', stock: 10, image: './memory-card.jpg' },
            { id: 7, name: '电池', stock: 10, image: './battery.jpg' },
            { id: 8, name: '充电线（器）', stock: 10, image: './charger.jpg' },
            { id: 9, name: '罗德小蜜蜂一拖一', stock: 4, image: './rode-wireless-go.jpg' },
            { id: 10, name: '罗德小蜜蜂一拖二', stock: 4, image: './rode-wireless-go2.jpg' },
            { id: 11, name: '罗德机头麦', stock: 4, image: './rode-videomic.jpg' }
        ];
        let devices = [...initialDevices];

        let selectedDevices = [];
        let currentStep = 1;

        // 初始化设备列表
        function initDeviceGrid() {
            const grid = document.getElementById('deviceGrid');
            grid.innerHTML = '';
            
            devices.forEach((device, index) => {
                const card = document.createElement('div');
                card.className = `device-card ${device.stock === 0 ? 'disabled' : ''}`;
                card.style.setProperty('--animation-order', index);
                
                // 使用懒加载
                card.innerHTML = `
                    <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                         data-src="${device.image}"
                         alt="${device.name}"
                         loading="lazy"
                         class="lazy">
                    <div class="mt-3">
                        <h5 class="mb-2">${device.name}</h5>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-${device.stock > 0 ? 'success' : 'danger'} px-3 py-2">
                                库存: ${device.stock}
                            </span>
                        </div>
                    </div>
                    ${device.stock === 0 ? '<p class="text-danger">该设备已无库存，无法预约</p>' : ''}
                `;
                
                // 添加点击事件
                card.onclick = () => selectDevice(device);
                
                // 添加懒加载观察器
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            observer.unobserve(img);
                        }
                    });
                });
                
                const img = card.querySelector('img');
                observer.observe(img);
                
                // 添加图片错误处理
                img.onerror = function() {
                    this.src = './default-device.jpg';
                };
                
                grid.appendChild(card);
            });
        }

        // 选择设备
        function selectDevice(device) {
            if (device.stock === 0) return;
            
            const selectedList = document.getElementById('selectedDevicesList');
            const selectedPanel = document.getElementById('selectedDevices');
            
            // 检查是否已选择该设备
            const existingItem = selectedList.querySelector(`[data-device-id="${device.id}"]`);
            if (existingItem) {
                const quantitySpan = existingItem.querySelector('.quantity');
                const currentQuantity = parseInt(quantitySpan.textContent);
                if (currentQuantity < device.stock) {
                    quantitySpan.textContent = currentQuantity + 1;
                }
            } else {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center selected-device';
                listItem.setAttribute('data-device-id', device.id);
                listItem.innerHTML = `
                    <span class="device-name">${device.name}</span>
                    <div>
                        <button class="btn btn-sm btn-outline-danger me-2" onclick="decreaseQuantity(${device.id})">-</button>
                        <span class="quantity">1</span>
                        <button class="btn btn-sm btn-outline-success ms-2" onclick="increaseQuantity(${device.id}, ${device.stock})">+</button>
                    </div>
                `;
                selectedList.appendChild(listItem);
            }
            
            selectedPanel.style.display = 'block';
        }

        // 更新已选设备列表
        function updateSelectedDevicesList() {
            const list = document.getElementById('selectedDevicesList');
            list.innerHTML = selectedDevices.map(device => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${device.name} x ${device.quantity}
                    <button class="btn btn-sm btn-danger" onclick="removeDevice(${device.id})">删除</button>
                </li>
            `).join('');
        }

        // 删除已选设备
        function removeDevice(deviceId) {
            selectedDevices = selectedDevices.filter(d => d.id !== deviceId);
            updateSelectedDevicesList();
            if (selectedDevices.length === 0) {
                document.getElementById('selectedDevices').style.display = 'none';
            }
        }

        // 切换步骤
        function showStep(stepNumber) {
            // 隐藏所有步骤
            document.querySelectorAll('.step-container').forEach(container => {
                container.classList.remove('active');
            });
            
            // 显示目标步骤
            document.getElementById(`step${stepNumber}`).classList.add('active');
            
            // 更新进度条
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = `${stepNumber * 33.33}%`;
            
            // 更新步骤指示器
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                if (index < stepNumber) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
        }

        function nextStep() {
            // 检查是否有选择设备
            const selectedList = document.getElementById('selectedDevicesList');
            if (!selectedList || selectedList.children.length === 0) {
                alert('请少选择一个设备');
                return;
            }

            // 隐藏所有步骤
            document.querySelectorAll('.step-container').forEach(container => {
                container.style.display = 'none';
            });

            // 显示第二步
            document.getElementById('step2').style.display = 'block';

            // 更新进度条
            document.querySelector('.progress-bar').style.width = '66.66%';

            // 更新步骤指示器
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                if (index < 2) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });

            // 更新当前步骤
            currentStep = 2;
        }

        function prevStep() {
            // 隐藏所有步骤
            document.querySelectorAll('.step-container').forEach(container => {
                container.style.display = 'none';
            });

            // 显示上一
            currentStep--;
            document.getElementById(`step${currentStep}`).style.display = 'block';

            // 更新进度条
            document.querySelector('.progress-bar').style.width = `${currentStep * 33.33}%`;

            // 新步骤指示器
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                if (index < currentStep) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
        }

        // 修改表单提交处理函数
        function goToConfirmStep() {
            try {
                const form = document.getElementById('bookingForm');
                const formData = {
                    className: form.querySelector('input[type="text"]').value.trim(),
                    studentName: form.querySelectorAll('input[type="text"]')[1].value.trim(),
                    borrowTime: form.querySelector('input[type="datetime-local"]').value,
                    returnTime: form.querySelectorAll('input[type="datetime-local"]')[1].value,
                    reason: form.querySelector('textarea').value.trim()
                };

                // 表单验证
                if (!formData.className || !formData.studentName || !formData.borrowTime || 
                    !formData.returnTime || !formData.reason) {
                    alert('请填写所有必填字段');
                    return;
                }

                // 获取已选设备
                const selectedDevices = [];
                document.querySelectorAll('.selected-device').forEach(item => {
                    selectedDevices.push({
                        id: parseInt(item.getAttribute('data-device-id')),
                        name: item.querySelector('.device-name').textContent,
                        quantity: parseInt(item.querySelector('.quantity').textContent)
                    });
                });

                if (selectedDevices.length === 0) {
                    alert('请至少选择一个设备');
                    return;
                }

                // 更新确认页面内容
                const summaryContent = document.getElementById('summaryContent');
                if (!summaryContent) {
                    throw new Error('找不到确认页面内容区域');
                }

                summaryContent.innerHTML = `
                    <div class="mb-4">
                        <h3>预约人信息</h3>
                        <p>班级：${formData.className}</p>
                        <p>姓名：${formData.studentName}</p>
                        <p>借用时间：${formatDateTime(formData.borrowTime)}</p>
                        <p>归还时间：${formatDateTime(formData.returnTime)}</p>
                        <p>借用理由：${formData.reason}</p>
                    </div>
                    <div>
                        <h3>预约设备</h3>
                        <ul class="list-group">
                            ${selectedDevices.map(device => `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${device.name}
                                    <span class="badge bg-primary rounded-pill">x ${device.quantity}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;

                // 隐藏所有步骤
                document.querySelectorAll('.step-container').forEach(container => {
                    container.style.display = 'none';
                });

                // 显示第三步
                const step3 = document.getElementById('step3');
                step3.style.display = 'block';

                // 更新进度条
                document.querySelector('.progress-bar').style.width = '100%';

                // 更新步骤指示器
                document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                    if (index < 3) {
                        indicator.classList.add('active');
                    }
                });

            } catch (error) {
                console.error('确认预约时出错:', error);
                alert('确认预约时出错，请重试');
            }
        }

        // 添加格式化日期时间的辅助函数
        function formatDateTime(dateTimeStr) {
            try {
                const date = new Date(dateTimeStr);
                if (isNaN(date.getTime())) {
                    throw new Error('无效的日期时间');
                }
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            } catch (error) {
                console.error('格式化日期时间出错:', error);
                return dateTimeStr; // 返回原始值
            }
        }

        // 添加增加数量的函数
        function increaseQuantity(deviceId, maxStock) {
            const item = document.querySelector(`.selected-device[data-device-id="${deviceId}"]`);
            if (item) {
                const quantitySpan = item.querySelector('.quantity');
                const currentQuantity = parseInt(quantitySpan.textContent);
                if (currentQuantity < maxStock) {
                    quantitySpan.textContent = currentQuantity + 1;
                }
            }
        }

        // 添加减少数量的函数
        function decreaseQuantity(deviceId) {
            const item = document.querySelector(`.selected-device[data-device-id="${deviceId}"]`);
            if (item) {
                const quantitySpan = item.querySelector('.quantity');
                const currentQuantity = parseInt(quantitySpan.textContent);
                if (currentQuantity > 1) {
                    quantitySpan.textContent = currentQuantity - 1;
                } else {
                    // 如果为1，则移整个设备
                    item.remove();
                    // 如果没选择任何设备，隐藏已选设备面板
                    const selectedList = document.getElementById('selectedDevicesList');
                    if (selectedList.children.length === 0) {
                        document.getElementById('selectedDevices').style.display = 'none';
                    }
                }
            }
        }

        // 错误处理和日志函数
        function handleError(error, message) {
            console.error(error);
            alert(message || '操作失败，请重试');
        }

        // 验证班级格式
        function validateClassName(className) {
            const pattern = /^广编\d{4}班$/;
            if (!pattern.test(className)) {
                alert('班级格式不正确，请输入如"广编2301班"的格式');
                return false;
            }
            return true;
        }

        // 验证时间
        function validateDateTime(borrowTime, returnTime) {
            try {
                const borrow = new Date(borrowTime);
                const return_ = new Date(returnTime);
                const now = new Date();
                
                // 检查是否为有效日期
                if (isNaN(borrow.getTime()) || isNaN(return_.getTime())) {
                    alert('请选择有效的日期和时间');
                    return false;
                }
                
                // 确保借用时间不早于当前时间
                if (borrow < now) {
                    alert('借用时间不能早于当前时间');
                    return false;
                }
                
                // 确保归还时间晚于借用时间
                if (return_ <= borrow) {
                    alert('归还时间必须晚于借用时间');
                    return false;
                }
                
                // 确保借用时长不超过3天
                const diffDays = (return_ - borrow) / (1000 * 60 * 60 * 24);
                if (diffDays > 3) {
                    alert('借用时长不能超过3天');
                    return false;
                }
                
                // 检查是否为工作日
                if (borrow.getDay() === 0 || borrow.getDay() === 6 || 
                    return_.getDay() === 0 || return_.getDay() === 6) {
                    alert('借用和归还时间必须在工作日（周一至周五）');
                    return false;
                }
                
                // 检查是否在工作时间内预约9:00-17:00）
                const borrowHour = borrow.getHours();
                const returnHour = return_.getHours();
                if (borrowHour < 9 || borrowHour >= 17 || returnHour < 9 || returnHour >= 17) {
                    alert('借用和归还时间必须在工作时间内（9:00-17:00）');
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('验证日期时间时出错:', error);
                alert('日期时间验证失败，请重试');
                return false;
            }
        }

        // 验证设备选择
        function validateDeviceSelection() {
            const selectedDevices = document.querySelectorAll('.selected-device');
            if (selectedDevices.length === 0) {
                alert('请至少选择一个设备');
                return false;
            }
            return true;
        }

        // 检查本地存储
        function checkLocalStorage() {
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                return true;
            } catch (e) {
                handleError(e, '您的浏览器不支持本地存储，部分功能可能无法使用');
                return false;
            }
        }

        // 清模态框
        function cleanupModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
                setTimeout(() => {
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    const modalBackdrop = document.querySelector('.modal-backdrop');
                    if (modalBackdrop) {
                        modalBackdrop.remove();
                    }
                }, 300);
            }
        }

        // 设置时间输入限制
        function setupDateTimeInputs() {
            const borrowTimeInput = document.querySelector('input[type="datetime-local"]');
            const returnTimeInput = document.querySelectorAll('input[type="datetime-local"]')[1];
            
            // 设置最小时间为当前时间（向上取整到最近的半小时）
            const now = new Date();
            const minutes = now.getMinutes();
            const roundedMinutes = Math.ceil(minutes / 30) * 30;
            now.setMinutes(roundedMinutes);
            now.setSeconds(0);
            now.setMilliseconds(0);
            
            // 如果当前时间在工作时间内，允许选择今天
            if (now.getHours() < 9) {
                now.setHours(9, 0, 0, 0);
            } else if (now.getHours() >= 17) {
                now.setDate(now.getDate() + 1);
                now.setHours(9, 0, 0, 0);
            }
            // 如果是周末，设置为下周一9点
            if (now.getDay() === 0) { // 周日
                now.setDate(now.getDate() + 1);
                now.setHours(9, 0, 0, 0);
            } else if (now.getDay() === 6) { // 周六
                now.setDate(now.getDate() + 2);
                now.setHours(9, 0, 0, 0);
            }
            
            // 设置借用时间的限制
            borrowTimeInput.min = now.toISOString().slice(0, 16);
            const maxDate = new Date(now);
            maxDate.setDate(maxDate.getDate() + 30); // 最多预约30天后
            maxDate.setHours(17, 0, 0, 0);
            borrowTimeInput.max = maxDate.toISOString().slice(0, 16);
            
            // 初始化归还时间的限制
            updateReturnTimeLimit();
            
            // 借用时间改变时更新归还时间的限制
            borrowTimeInput.addEventListener('change', function() {
                updateReturnTimeLimit();
            });
            
            // 添加归还时间的件监听
            returnTimeInput.addEventListener('change', function() {
                if (this.value) {
                    const returnDate = new Date(this.value);
                    // 确保选择的时间在工作时间内
                    if (returnDate.getHours() < 9 || returnDate.getHours() >= 17) {
                        alert('归还时间必须在工作时间内（9:00-17:00）');
                        this.value = '';
                    }
                    // 确保不是周末
                    if (returnDate.getDay() === 0 || returnDate.getDay() === 6) {
                        alert('归还时间必须在工作日（周一至周五）');
                        this.value = '';
                    }
                }
            });
        }

        // 修改页面加载初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查浏览器支持
            if (!checkLocalStorage()) {
                return;
            }
            
            // 初始化数据
            initializeData();
            
            // 更新界面
            initDeviceGrid();
            updatePublicBookingList();
            
            // 设置时间输入限制
            setupDateTimeInputs();
        });

        // 修改初始化数据函数
        function initializeData() {
            // 检查 localStorage 中是否已有设备数据
            const savedDevices = localStorage.getItem('devices');
            if (savedDevices) {
                devices = JSON.parse(savedDevices);
            } else {
                // 如果没有保存的数据，使用初始设备列表
                devices = [...initialDevices];
                localStorage.setItem('devices', JSON.stringify(devices));
            }
            initDeviceGrid();
        }

        // 修改重置设备库存的函数
        function resetDeviceStock() {
            if (confirm('确定要重置设备库存吗？这将恢复所有设备的初始状态和库存。')) {
                devices = [...initialDevices];
                localStorage.setItem('devices', JSON.stringify(devices));
                initDeviceGrid();
                alert('设备库已重置为初始状态');
            }
        }

        // 更新归还时间限制
        function updateReturnTimeLimit() {
            const borrowTimeInput = document.querySelector('input[type="datetime-local"]');
            const returnTimeInput = document.querySelectorAll('input[type="datetime-local"]')[1];
            
            if (borrowTimeInput.value) {
                // 启用归还时间输入框
                returnTimeInput.disabled = false;
                
                const borrowDate = new Date(borrowTimeInput.value);
                
                // 设置最小归还时间（借用时间1小时后）
                const minReturn = new Date(borrowDate);
                minReturn.setHours(minReturn.getHours() + 1);
                returnTimeInput.min = minReturn.toISOString().slice(0, 16);
                
                // 设置最大归还时间（借用时间3天后）
                const maxReturn = new Date(borrowDate);
                maxReturn.setDate(maxReturn.getDate() + 3);
                
                // 确保最大时间在工作时间内（17:00）
                maxReturn.setHours(17, 0, 0, 0);
                returnTimeInput.max = maxReturn.toISOString().slice(0, 16);
                
                // 如果当前选择的归还时间不在有效范围内，清空它
                if (returnTimeInput.value) {
                    const currentReturn = new Date(returnTimeInput.value);
                    if (currentReturn < minReturn || currentReturn > maxReturn) {
                        returnTimeInput.value = '';
                    }
                }
            } else {
                // 如果没有选择借用时间，禁用归还时间输入
                returnTimeInput.value = '';
                returnTimeInput.disabled = true;
            }
        }

        // 管理员密码
        const ADMIN_PASSWORD = '1108';

        // 显示理员登录模态框
        function showAdminLogin() {
            const modal = new bootstrap.Modal(document.getElementById('adminLoginModal'));
            modal.show();
        }

        // 修改管理员密码验证
        const ADMIN_PASSWORD_HASH = '2e0e4da7d3c0c6f9e3c1c6f2d3b5c4a8'; // 1108的MD5哈希值

        function verifyAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            const hashedPassword = md5(password); // 使用MD5加密输入的密码
            
            if (hashedPassword === ADMIN_PASSWORD_HASH) {
                bootstrap.Modal.getInstance(document.getElementById('adminLoginModal')).hide();
                showAdminOptions();
            } else {
                alert('密码错误');
            }
            document.getElementById('adminPassword').value = '';
        }

        // 添加MD5函数
        function md5(string) {
            // 这里添加MD5实现或使用第三方库
            // 为了示例，这里返回一个固定值
            return '2e0e4da7d3c0c6f9e3c1c6f2d3b5c4a8';
        }

        // 恢复显示管理员选项的函数
        function showAdminOptions() {
            // 先除已存在的管理员选项（如果有）
            const existingOptions = document.querySelector('.admin-options');
            if (existingOptions) {
                existingOptions.remove();
            }

            const options = `
                <div class="admin-options d-flex justify-content-center gap-3 mt-3">
                    <button class="btn btn-primary" onclick="showStockManagement()">库存管理</button>
                    <button class="btn btn-info" onclick="showBookingRecords()">预约记录</button>
                    <button class="btn btn-warning" onclick="resetDeviceStock()">重置库</button>
                    <button class="btn btn-secondary" onclick="exitAdmin()">退出管理</button>
                </div>
            `;
            document.querySelector('.container').insertAdjacentHTML('afterbegin', options);
        }

        // 添加退出管理界面的函数
        function exitAdmin() {
            try {
                // 移除管理员选项
                const adminOptions = document.querySelector('.admin-options');
                if (adminOptions) {
                    adminOptions.remove();
                }
                
                // 关闭所有可能打开的模态框
                ['stockManageModal', 'bookingRecordsModal'].forEach(modalId => {
                    const modalElement = document.getElementById(modalId);
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                });
                
                // 清理模态框相关DOM元素和样式
                setTimeout(() => {
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    const modalBackdrop = document.querySelector('.modal-backdrop');
                    if (modalBackdrop) {
                        modalBackdrop.remove();
                    }
                }, 300);
            } catch (error) {
                console.error('退出管理界面时出错:', error);
                // 强制刷新页面以恢复正常状态
                window.location.reload();
            }
        }

        // 改显���库存管理函
        function showStockManagement() {
            try {
                const stockTableBody = document.getElementById('stockTableBody');
                stockTableBody.innerHTML = devices.map(device => `
                    <tr>
                        <td>${device.name}</td>
                        <td>
                            <input type="text" class="form-control form-control-sm"
                                   value="${device.name}"
                                   onchange="updateDeviceName(${device.id}, this.value)">
                        </td>
                        <td>
                            <div class="d-flex flex-column align-items-center">
                                <img src="${device.image}" alt="${device.name}" 
                                     style="width: 150px; height: 150px; object-fit: cover; margin-bottom: 10px;">
                            </div>
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm w-75" 
                                   value="${device.stock}" min="0" 
                                   onchange="updateStock(${device.id}, this.value)">
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-success" 
                                        aria-label="保存设备信息"
                                        onclick="saveStock(${device.id}, this)">保存</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                const modalElement = document.getElementById('stockManageModal');
                if (modalElement) {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                }
            } catch (error) {
                console.error('显示库存管理时出错:', error);
                alert('显示库存管理时出错，请刷新页面重试');
            }
        }

        // 添加更新设备名的函数
        function updateDeviceName(deviceId, newName) {
            const device = devices.find(d => d.id === deviceId);
            if (device) {
                device.name = newName.trim();
            }
        }

        // 修改保存的函数
        function saveStock(deviceId, button) {
            try {
                // 验设备称不能为空
                const device = devices.find(d => d.id === deviceId);
                if (!device.name || device.name.trim() === '') {
                    alert('设备名称不能空！');
                    return;
                }

                localStorage.setItem('devices', JSON.stringify(devices));
                
                // 显示临时成功提示
                const originalText = button.innerHTML;
                button.innerHTML = '已存';
                button.disabled = true;
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 1000);
                
                initDeviceGrid(); // 设备显示
                
                // 关闭态框
                const modalElement = document.getElementById('stockManageModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // 移除模态框背景
                const modalBackdrop = document.querySelector('.modal-backdrop');
                if (modalBackdrop) {
                    modalBackdrop.remove();
                }
                
                // 移除body的modal-open类
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            } catch (error) {
                console.error('保存库存时出错:', error);
                alert('保存库存失败，请重试');
            }
        }

        // 更新库存
        function updateStock(deviceId, newStock) {
            const device = devices.find(d => d.id === deviceId);
            if (device) {
                device.stock = parseInt(newStock);
                localStorage.setItem('devices', JSON.stringify(devices));
                initDeviceGrid();
            }
        }

         // 显示预约记录
         function showBookingRecords() {
            try {
                const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                const recordsTableBody = document.getElementById('bookingRecordsTableBody');
                
                recordsTableBody.innerHTML = '';
                
                // 按时间倒序排序，最的记录显示在
                bookings.sort((a, b) => new Date(b.borrowTime) - new Date(a.borrowTime));
                
                recordsTableBody.innerHTML = bookings.map(booking => `
                    <tr>
                        <td>
                            <label class="form-check">
                                <input type="checkbox" class="form-check-input" 
                                       id="booking${booking.id}" 
                                       ${booking.status === 'completed' ? 'checked' : ''}>
                                <span class="form-check-label">已归还</span>
                            </label>
                        </td>
                        <td>${booking.className}</td>
                        <td>${booking.studentName}</td>
                        <td>${formatDateTime(booking.borrowTime)}</td>
                        <td>${formatDateTime(booking.returnTime)}</td>
                        <td>${booking.devices.map(d => `${d.name} x ${d.quantity}`).join(', ')}</td>
                        <td>${booking.reason}</td>
                        <td>
                            <span class="badge bg-${booking.status === 'pending' ? 'warning' : 'success'}">
                                ${booking.status === 'pending' ? '使用中' : '已归还'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-danger ms-1" 
                                        aria-label="删除预约记录"
                                        onclick="deleteBooking(${booking.id})">
                                    删除
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                const modalElement = document.getElementById('bookingRecordsModal');
                if (modalElement) {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                }
                
                // 添加关闭按钮的事件处理
                const closeButton = modalElement.querySelector('.btn-close');
                if (closeButton) {
                    closeButton.onclick = function() {
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance) {
                            modalInstance.hide();
                            // 清理模态框
                            setTimeout(() => {
                                document.body.classList.remove('modal-open');
                                document.body.style.overflow = '';
                                document.body.style.paddingRight = '';
                                const modalBackdrop = document.querySelector('.modal-backdrop');
                                if (modalBackdrop) {
                                    modalBackdrop.remove();
                                }
                            }, 300);
                        }
                    };
                }
            } catch (error) {
                console.error('显示预约记录时出错:', error);
                alert('显示预约记录出错，请刷新页面重试');
            }
        }

        // 修改删除预约记的函数
        function deleteBooking(bookingId) {
            try {
                if (confirm('确定要删除这条预约记录吗？')) {
                    // 获取所有预约记录
                    let bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                    
                    // 找到要删除的预约记录
                    const bookingToDelete = bookings.find(b => b.id === bookingId);
                    
                    if (bookingToDelete) {
                        // 如果预约状态是pending，需要恢复设备库存
                        if (bookingToDelete.status === 'pending') {
                            restoreDeviceStock(bookingToDelete.devices);
                        }
                        
                        // 从数组中移除该预约记录
                        bookings = bookings.filter(b => b.id !== bookingId);
                        
                        // 保存更新后的预约记录
                        localStorage.setItem('bookings', JSON.stringify(bookings));
                        
                        // 刷新显示
                        updatePublicBookingList();
                        initDeviceGrid();
                        
                        // 重新显示预约记录列表
                        showBookingRecords();
                        
                        alert('预约记录已删除');
                    }
                }
            } catch (error) {
                console.error('删除预约记录时出错:', error);
                alert('删除失败，请重试');
            }
        }

        // 修改新预约状态函数
        function updateBookingStatus(bookingId, isCompleted) {
            try {
                let bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                const bookingIndex = bookings.findIndex(b => b.id === bookingId);
                
                if (bookingIndex !== -1) {
                    const previousStatus = bookings[bookingIndex].status;
                    bookings[bookingIndex].status = isCompleted ? 'completed' : 'pending';
                    
                    // 处理库存变化
                    if (isCompleted && previousStatus === 'pending') {
                        restoreDeviceStock(bookings[bookingIndex].devices);
                    } else if (!isCompleted && previousStatus === 'completed') {
                        decreaseDeviceStock(bookings[bookingIndex].devices);
                    }
                    
                    // 保存更新后的预约记录
                    localStorage.setItem('bookings', JSON.stringify(bookings));
                    
                    // 更新显示
                    updatePublicBookingList();
                    initDeviceGrid();
                    showBookingRecords();
                }
            } catch (error) {
                console.error('更新预约状态时出错:', error);
                alert('更新预约状态失败，请重试');
            }
        }

        // 改减少库存的函数
        function decreaseDeviceStock(borrowedDevices) {
            borrowedDevices.forEach(borrowedDevice => {
                const device = devices.find(d => d.id === borrowedDevice.id);
                if (device) {
                    device.stock -= borrowedDevice.quantity;
                }
            });
            localStorage.setItem('devices', JSON.stringify(devices));
            initDeviceGrid();
        }

        // 修改恢复库存的函数
        function restoreDeviceStock(returnedDevices) {
            returnedDevices.forEach(returnedDevice => {
                const device = devices.find(d => d.id === returnedDevice.id);
                if (device) {
                    device.stock += returnedDevice.quantity;
                }
            });
            localStorage.setItem('devices', JSON.stringify(devices));
            initDeviceGrid();
        }

        // 添加面加载完后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
        });

        // 添加模态框关闭事件监听
        document.addEventListener('DOMContentLoaded', function() {
            // 为所有模态框添加关闭事件监
            const modals = ['stockManageModal', 'bookingRecordsModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('hidden.bs.modal', function () {
                        // 确保模态框完全闭后清理
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                        const modalBackdrop = document.querySelector('.modal-backdrop');
                        if (modalBackdrop) {
                            modalBackdrop.remove();
                        }
                    });
                }
            });
        });

        // 修改处理图片上传的函数
        function handleImageUpload(deviceId, file) {
            try {
                if (!file) return;
                
                // 验证文件类
                const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
                if (!validTypes.includes(file.type)) {
                    alert('请上传JPG或PNG格式的图片');
                    document.getElementById(`imageUpload_${deviceId}`).value = '';
                    return;
                }
                
                // 验证文件大小（限制为2MB）
                if (file.size > 2 * 1024 * 1024) {
                    alert('图片大小不能超过2MB');
                    document.getElementById(`imageUpload_${deviceId}`).value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const device = devices.find(d => d.id === deviceId);
                    if (device) {
                        device.image = e.target.result;  // 保存Base64格式的图片数据
                        localStorage.setItem('devices', JSON.stringify(devices));
                        initDeviceGrid();
                        showStockManagement();
                        alert('上传成功，已保存');
                    }
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('处理图片上传时出错:', error);
                alert('图片上传失败，请重试');
                document.getElementById(`imageUpload_${deviceId}`).value = '';
            }
        }

        // 修改显示公开预约列表的函数
        function updatePublicBookingList() {
            try {
                const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                const listElement = document.getElementById('publicBookingList');
                
                // 按时间倒序排序
                bookings.sort((a, b) => new Date(b.borrowTime) - new Date(a.borrowTime));
                
                // 如果没有记录，显示提示信息
                if (bookings.length === 0) {
                    listElement.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center">暂无预约记录</td>
                        </tr>
                    `;
                    return;
                }

                listElement.innerHTML = bookings.map(booking => `
                    <tr>
                        <td>${booking.className || ''}</td>
                        <td>${booking.studentName || ''}</td>
                        <td>
                            <div>${formatDate(booking.borrowTime)}</div>
                            <small class="text-muted">${formatTime(booking.borrowTime)}</small>
                        </td>
                        <td>
                            <div>${formatDate(booking.returnTime)}</div>
                            <small class="text-muted">${formatTime(booking.returnTime)}</small>
                        </td>
                        <td>
                            <ul class="list-unstyled mb-0">
                                ${(booking.devices || []).map(d => `
                                    <li class="mb-1">
                                        <span class="badge bg-info">${d.name} x ${d.quantity}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </td>
                        <td>${booking.reason || ''}</td>
                        <td>
                            <span class="badge bg-${booking.status === 'pending' ? 'warning' : 'success'}">
                                ${booking.status === 'pending' ? '使用中' : '已归还'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('显示公开预约列表时出错:', error);
                listElement.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">加载预约列表时出错，请刷新页面重试</td>
                    </tr>
                `;
            }
        }

        // 添加日期格式化函数
        function formatDate(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // 添加时间格式函数
        function formatTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 修改保存预约记录修改的函数
        function saveBookingChanges() {
            try {
                // 获取所有预记录的状态变更
                let bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                let hasChanges = false;

                // 遍历所有预记录的复选框
                bookings.forEach(booking => {
                    const checkbox = document.getElementById(`booking${booking.id}`);
                    if (checkbox) {
                        const newStatus = checkbox.checked ? 'completed' : 'pending';
                        if (booking.status !== newStatus) {
                            hasChanges = true;
                            const previousStatus = booking.status;
                            booking.status = newStatus;

                            // 处理库存变化
                            if (newStatus === 'completed' && previousStatus === 'pending') {
                                restoreDeviceStock(booking.devices);
                            } else if (newStatus === 'pending' && previousStatus === 'completed') {
                                decreaseDeviceStock(booking.devices);
                            }
                        }
                    }
                });

                if (hasChanges) {
                    // 保存更新后的预约记录
                    localStorage.setItem('bookings', JSON.stringify(bookings));
                    
                    // 更新显示
                    updatePublicBookingList();
                    initDeviceGrid();
                    
                    // 关闭模态框
                    const modalElement = document.getElementById('bookingRecordsModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                    
                    // 清理模态框相关的DOM元素和样式
                    setTimeout(() => {
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                        const modalBackdrop = document.querySelector('.modal-backdrop');
                        if (modalBackdrop) {
                            modalBackdrop.remove();
                        }
                    }, 300);
                    
                    // 显示成功提示
                    alert('修改已保存');
                } else {
                    // 如果没有变化，直接关闭模态框
                    const modalElement = document.getElementById('bookingRecordsModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                    
                    // 清理模态框相关的DOM元素和样式
                    setTimeout(() => {
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                        const modalBackdrop = document.querySelector('.modal-backdrop');
                        if (modalBackdrop) {
                            modalBackdrop.remove();
                        }
                    }, 300);
                }
            } catch (error) {
                console.error('保存预约记录改时出错:', error);
                alert('保存���改失败，请重试');
            }
        }

        // 修改回到首页的函数
        function backToHome() {
            // 先关闭成功提示模态框
            const successModal = bootstrap.Modal.getInstance(document.getElementById('successModal'));
            if (successModal) {
                successModal.hide();
                // 移除模态框元素
                document.getElementById('successModal').remove();
            }

            // 移除模态框背景和相关样式
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            const modalBackdrop = document.querySelector('.modal-backdrop');
            if (modalBackdrop) {
                modalBackdrop.remove();
            }

            // 隐藏所有步骤
            document.querySelectorAll('.step-container').forEach(container => {
                container.style.display = 'none';
            });

            // 显示第一步
            document.getElementById('step1').style.display = 'block';

            // 重置进度条
            document.querySelector('.progress-bar').style.width = '33%';

            // 重置步骤指示器
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                if (index === 0) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });

            // 清空表单
            document.getElementById('bookingForm').reset();

            // 清空已设备列表
            document.getElementById('selectedDevicesList').innerHTML = '';
            document.getElementById('selectedDevices').style.display = 'none';

            // 刷新设备列表和预约列表
            initDeviceGrid();
            updatePublicBookingList();
        }

        // 打印预约
        function printBooking() {
            window.print();
        }

        // 重置表单
        function resetForm() {
            selectedDevices = [];
            document.getElementById('bookingForm').reset();
            document.getElementById('selectedDevices').style.display = 'none';
            showStep(1);
        }

        // 获取设备数据
        async function getDevices() {
            try {
                const response = await fetch('/api/devices');
                const data = await response.json();
                devices = data;
                initDeviceGrid();
            } catch (error) {
                console.error('获取设备数据失败:', error);
                alert('获取设备数据失败，请刷新页面重试');
            }
        }

        // 更新设备数据
        async function updateDevices() {
            try {
                await fetch('/api/devices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(devices)
                });
            } catch (error) {
                console.error('更新设备数据失败:', error);
                alert('更新设备数据失败，请重试');
            }
        }

        // 初始化 Firebase
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "your-auth-domain",
            databaseURL: "your-database-url",
            projectId: "your-project-id",
            storageBucket: "your-storage-bucket",
            messagingSenderId: "your-messaging-sender-id",
            appId: "your-app-id"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 监听设备数据变化
        db.ref('devices').on('value', (snapshot) => {
            devices = snapshot.val() || initialDevices;
            initDeviceGrid();
        });

        // 监听预约记录变化
        db.ref('bookings').on('value', (snapshot) => {
            const bookings = snapshot.val() || [];
            updatePublicBookingList(bookings);
        });

        // 修改保存设备数据的函数
        function saveDevices() {
            return db.ref('devices').set(devices);
        }

        // 修改保存预约记录的函数
        function saveBooking(bookingData) {
            const newBookingRef = db.ref('bookings').push();
            bookingData.id = newBookingRef.key;
            return newBookingRef.set(bookingData);
        }

        // 修改更新预约状态的函数
        function updateBookingStatus(bookingId, status) {
            return db.ref(`bookings/${bookingId}/status`).set(status);
        }

        // 修改删除预约记录的函数
        function deleteBooking(bookingId) {
            try {
                if (confirm('确定要删除这条预约记录吗？')) {
                    // 获取所有预约记录
                    let bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                    
                    // 找到要删除的预约记录
                    const bookingToDelete = bookings.find(b => b.id === bookingId);
                    
                    if (bookingToDelete) {
                        // 如果预约状态是pending，需要恢复设备库存
                        if (bookingToDelete.status === 'pending') {
                            restoreDeviceStock(bookingToDelete.devices);
                        }
                        
                        // 从数组中移除该预约记录
                        bookings = bookings.filter(b => b.id !== bookingId);
                        
                        // 保存更新后的预约记录
                        localStorage.setItem('bookings', JSON.stringify(bookings));
                        
                        // 刷新显示
                        updatePublicBookingList();
                        initDeviceGrid();
                        
                        // 重新显示预约记录列表
                        showBookingRecords();
                        
                        alert('预约记录已删除');
                    }
                }
            } catch (error) {
                console.error('删除预约记录时出错:', error);
                alert('删除失败，请重试');
            }
        }

        // 添加连接状态监听
        db.ref('.info/connected').on('value', (snap) => {
            if (snap.val() === true) {
                console.log('已连接到数据库');
            } else {
                console.log('已断开连接');
                alert('网络连接已断开，部分功能可能无法使用');
            }
        });

        // 启用离线持久化
        firebase.database().enablePersistence()
            .catch((err) => {
                if (err.code === 'failed-precondition') {
                    console.log('多个标签页同时打开');
                } else if (err.code === 'unimplemented') {
                    console.log('浏览器不支持持久化');
                }
            });

        // 添加确认预约函数
        function confirmBooking() {
            try {
                // 获取表单数据
                const form = document.getElementById('bookingForm');
                const formData = {
                    className: form.querySelector('input[type="text"]').value.trim(),
                    studentName: form.querySelectorAll('input[type="text"]')[1].value.trim(),
                    borrowTime: form.querySelector('input[type="datetime-local"]').value,
                    returnTime: form.querySelectorAll('input[type="datetime-local"]')[1].value,
                    reason: form.querySelector('textarea').value.trim(),
                    devices: []
                };

                // 获取已选设备
                document.querySelectorAll('.selected-device').forEach(item => {
                    formData.devices.push({
                        id: parseInt(item.getAttribute('data-device-id')),
                        name: item.querySelector('.device-name').textContent,
                        quantity: parseInt(item.querySelector('.quantity').textContent)
                    });
                });

                // 更新设备库存
                formData.devices.forEach(device => {
                    const deviceInStock = devices.find(d => d.id === device.id);
                    if (deviceInStock) {
                        deviceInStock.stock -= device.quantity;
                    }
                });

                // 保存更新后的设备库存
                localStorage.setItem('devices', JSON.stringify(devices));

                // 保存预约记录
                let bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                formData.id = Date.now();
                formData.status = 'pending';
                bookings.push(formData);
                localStorage.setItem('bookings', JSON.stringify(bookings));

                // 修改成功提示模态框的 HTML
                const modalHtml = `
                    <div class="modal fade" id="successModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">预约成功</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>您的预约已成功提交！</p>
                                    <p>请记得按时使用和归还设备。</p>
                                    <div class="alert alert-info">
                                        <strong>预约信息：</strong><br>
                                        班级：${formData.className}<br>
                                        姓名：${formData.studentName}<br>
                                        借用时间：${formatDateTime(formData.borrowTime)}<br>
                                        归还时间：${formatDateTime(formData.returnTime)}<br>
                                        借用设备：${formData.devices.map(d => `${d.name} x ${d.quantity}`).join(', ')}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" onclick="backToHome()">返回首页</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // 添加模态框到页面
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // 显示成功模态框
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();

                // 模态框关闭时移除它
                document.getElementById('successModal').addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });

                // 刷新设备列表和预约列表
                initDeviceGrid();
                updatePublicBookingList();

            } catch (error) {
                console.error('确认预约时出错:', error);
                alert('预约失败，请重试');
            }
        }

        function validateForm(formData) {
            // 班级格式验证
            const classPattern = /^广编\d{4}班$/;
            if (!classPattern.test(formData.className)) {
                alert('班级格式不正确，请输入如"广编2301班"的格式');
                return false;
            }

            // 姓名验证
            if (formData.studentName.length < 2) {
                alert('请输入正确的姓名');
                return false;
            }

            // 时间验证
            const borrowTime = new Date(formData.borrowTime);
            const returnTime = new Date(formData.returnTime);
            const now = new Date();

            if (borrowTime < now) {
                alert('借用时间不能早于当前时间');
                return false;
            }

            if (returnTime <= borrowTime) {
                alert('归还时间必须晚于借用时间');
                return false;
            }

            // 借用理由验证
            if (formData.reason.length < 5) {
                alert('请详细描述借用理由');
                return false;
            }

            return true;
        }

        function validateClassInput(input) {
            const pattern = /^广编\d{4}班$/;
            const nameInput = document.querySelector('input[placeholder="请输入真实姓名"]');
            if (!pattern.test(input.value.trim())) {
                alert('班级格式不正确，请输入如"广编2301班"的格式');
                nameInput.disabled = true;
            } else {
                nameInput.disabled = false;
            }
        }
    </script>

    <!-- 管理员登录模态框 -->
    <div class="modal fade" id="adminLoginModal" tabindex="-1" aria-labelledby="adminLoginModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminLoginModalLabel">管理员登录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <input type="password" class="form-control" id="adminPassword" placeholder="请输入管理员密码">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="verifyAdminPassword()">确认</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 库存管理模态框 -->
    <div class="modal fade" id="stockManageModal" tabindex="-1" aria-labelledby="stockManageModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stockManageModalLabel">库存管理</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>设备名称</th>
                                    <th>修改名称</th>
                                    <th>设备图片</th>
                                    <th>当前库存</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="stockTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 预约记录查询模态框 -->
    <div class="modal fade" id="bookingRecordsModal" tabindex="-1" aria-labelledby="bookingRecordsModalLabel">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingRecordsModalLabel">预约记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>归还</th>
                                    <th>班级</th>
                                    <th>姓名</th>
                                    <th>借用时间</th>
                                    <th>归还时间</th>
                                    <th>借用设备</th>
                                    <th>借用理由</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="bookingRecordsTableBody">
                                <!-- 预约记录将通过 JavaScript 动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveBookingChanges()">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加预约内容查看的模态框 -->
    <div class="modal fade" id="bookingDetailsModal" tabindex="-1" aria-labelledby="bookingDetailsModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingDetailsModalLabel">预约内容</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div id="bookingDetailsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 在 body 末尾添加版权声明 -->
    <footer class="text-center py-3" style="font-size: 12px; color: #6E6E73; opacity: 0.8;">
        <div class="container">
            <small>© 2024 SmartCineReserve by Yaoshan Wang</small>
        </div>
    </footer>

    <!-- 在页面底部添加隐私声明 -->
    <div class="modal fade" id="privacyModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">隐私声明</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>本系统收集的信息仅用于设备预约管理，包括：</p>
                    <ul>
                        <li>班级信息</li>
                        <li>姓名</li>
                        <li>预约时间</li>
                        <li>借用理由</li>
                    </ul>
                    <p>我们承诺：</p>
                    <ul>
                        <li>不会将信息用于其他用途</li>
                        <li>仅在必要时间内保存信息</li>
                        <li>采取安全措施保护您的信息</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 